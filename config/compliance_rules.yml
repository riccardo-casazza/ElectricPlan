# Electrical Installation Compliance Rules
# This file centralizes all compliance validation rules

# ========================================
# BREAKER RULES
# ========================================
breaker_rules:
  light_only:
    applies_to: Breaker
    description: "Light breakers must contain only lights"
    condition:
      type: has_light_items
    validation:
      type: exclusive_type
      required_type: light
    severity: error
    message: "This breaker contains non-light items"
    help: "Remove {non_light_items} or move lights to another breaker"

  light_max_count:
    applies_to: Breaker
    description: "Light breakers can have maximum 8 lights"
    condition:
      type: has_light_items
    validation:
      type: max_count
      attribute: light_items
      max_value: 8
    severity: error
    message: "Light breaker has {actual_count} lights (maximum {max_value} allowed)"
    help: "Remove excess lights or split across multiple breakers"

  light_max_current:
    applies_to: Breaker
    description: "Light breakers must be maximum 16A"
    condition:
      type: has_light_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 16
    severity: error
    message: "Light breaker is {actual_value}A (maximum {max_value}A allowed)"
    help: "Use a lower amperage breaker or move some lights to another circuit"

  socket_only:
    applies_to: Breaker
    description: "Socket breakers must contain only sockets"
    condition:
      type: has_socket_items
    validation:
      type: exclusive_type
      required_type: socket
    severity: error
    message: "This breaker contains non-socket items"
    help: "Remove {non_socket_items} or move sockets to another breaker"

  socket_16a_max_count:
    applies_to: Breaker
    description: "16A socket breakers can have maximum 8 sockets"
    condition:
      type: socket_breaker_16a
    validation:
      type: max_count
      attribute: socket_items
      max_value: 8
    severity: error
    message: "16A socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Remove excess sockets or use a 20A breaker"

  socket_16a_cable:
    applies_to: Breaker
    description: "16A socket breakers must use 1.5mm2 cable"
    condition:
      type: socket_breaker_16a
    validation:
      type: association_attribute
      path: breaker.output_cable.section
      must_equal: "1.5mm2"
    severity: error
    message: "16A socket breaker must use 1.5mm2 cable (currently: {actual_value})"
    help: "Change the output cable to 1.5mm2"

  socket_20a_max_count:
    applies_to: Breaker
    description: "20A socket breakers can have maximum 12 sockets"
    condition:
      type: socket_breaker_20a
    validation:
      type: max_count
      attribute: socket_items
      max_value: 12
    severity: error
    message: "20A socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Remove excess sockets or split across multiple breakers"

  socket_20a_cable:
    applies_to: Breaker
    description: "20A socket breakers must use 2.5mm2 cable"
    condition:
      type: socket_breaker_20a
    validation:
      type: association_attribute
      path: breaker.output_cable.section
      must_equal: "2.5mm2"
    severity: error
    message: "20A socket breaker must use 2.5mm2 cable (currently: {actual_value})"
    help: "Change the output cable to 2.5mm2"

  socket_invalid_current:
    applies_to: Breaker
    description: "Socket breakers must be either 16A or 20A"
    condition:
      type: has_socket_items
    validation:
      type: attribute_in_list
      attribute: output_max_current
      allowed_values: [16, 20]
    severity: error
    message: "Socket breaker is {actual_value}A (must be 16A or 20A)"
    help: "Change breaker amperage to either 16A or 20A"

  kitchen_socket_current:
    applies_to: Breaker
    description: "Kitchen socket breakers must be 20A"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 20
    severity: error
    message: "Kitchen socket breaker must be 20A (currently: {actual_value}A)"
    help: "Change breaker amperage to 20A for kitchen sockets"

  kitchen_socket_min_current:
    applies_to: Breaker
    description: "Kitchen socket breakers must be 20A"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: attribute_in_list
      attribute: output_max_current
      allowed_values: [20]
    severity: error
    message: "Kitchen socket breaker must be 20A (currently: {actual_value}A)"
    help: "Change breaker amperage to 20A for kitchen sockets"

  kitchen_socket_cable:
    applies_to: Breaker
    description: "Kitchen socket breakers must use 2.5mm2 cable"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: association_attribute
      path: breaker.output_cable.section
      must_equal: "2.5mm2"
    severity: error
    message: "Kitchen socket breaker must use 2.5mm2 cable (currently: {actual_value})"
    help: "Change the output cable to 2.5mm2 for kitchen sockets"

  kitchen_socket_max_count:
    applies_to: Breaker
    description: "Kitchen socket breakers can have maximum 6 sockets"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: max_count
      attribute: socket_items
      max_value: 6
    severity: error
    message: "Kitchen socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Kitchen circuits are limited to 6 sockets maximum"

  shutter_current:
    applies_to: Breaker
    description: "Shutter breakers must be 16A"
    condition:
      type: has_shutter_items
    validation:
      type: attribute_in_list
      attribute: output_max_current
      allowed_values: [16]
    severity: error
    message: "Shutter breaker must be 16A (currently: {actual_value}A)"
    help: "Change breaker amperage to 16A for shutters"

  shutter_cable:
    applies_to: Breaker
    description: "Shutter breakers must use 1.5mm2 cable"
    condition:
      type: has_shutter_items
    validation:
      type: association_attribute
      path: breaker.output_cable.section
      must_equal: "1.5mm2"
    severity: error
    message: "Shutter breaker must use 1.5mm2 cable (currently: {actual_value})"
    help: "Change the output cable to 1.5mm2 for shutters"

# ========================================
# ITEM RULES
# ========================================
item_rules:
  cooktop_rcd_type:
    applies_to: Item
    description: "Cooktop must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: cooktop
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "Cooktop must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this cooktop to a breaker under an RCD type A"

  washing_machine_rcd_type:
    applies_to: Item
    description: "Washing machine must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: washing machine
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "Washing machine must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this washing machine to a breaker under an RCD type A"

  ev_charger_rcd_type:
    applies_to: Item
    description: "EV charger must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: ev charger
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "EV charger must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this EV charger to a breaker under an RCD type A"

# ========================================
# RCD RULES
# ========================================
rcd_rules:
  max_breakers:
    applies_to: ResidualCurrentDevice
    description: "RCD can have maximum 8 breakers"
    validation:
      type: association_count
      association: breakers
      max_count: 8
    severity: error
    message: "RCD has {actual_count} breakers (maximum {max_count} allowed)"
    help: "Remove excess breakers or add another RCD"

  load_capacity:
    applies_to: ResidualCurrentDevice
    description: "RCD current capacity must handle connected load"
    validation:
      type: load_calculation
      full_load_types:
        - ev charger
        - convector
        - water heater
        - a/c
    severity: error
    message: "RCD max current ({rcd_current}A) insufficient for load ({required_current}A)"
    help: "Use a higher amperage RCD or redistribute load across multiple RCDs"

# ========================================
# SYSTEM RULES
# ========================================
system_rules:
  min_light_circuits:
    applies_to: System
    description: "Installation must have minimum 2 light breakers"
    validation:
      type: min_light_breakers
      min_value: 2
    severity: error
    message: "Installation has only {actual_count} light breaker(s) (minimum {min_value} required)"
    help: "Create at least one additional breaker with light items"

  min_shutter_circuits:
    applies_to: System
    description: "Installation must have at least 1 dedicated shutter breaker"
    validation:
      type: min_shutter_breakers
      min_value: 1
    severity: error
    message: "Installation has {actual_count} shutter breaker(s) (minimum {min_value} required)"
    help: "Create at least one breaker dedicated to roller shutters"
