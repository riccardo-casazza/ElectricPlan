# Electrical Installation Compliance Rules
# This file centralizes all compliance validation rules

# ========================================
# BREAKER RULES
# ========================================
breaker_rules:
  light_only:
    applies_to: Breaker
    description: "Light breakers must contain only lights"
    condition:
      type: has_light_items
    validation:
      type: exclusive_type
      required_type: light
    severity: error
    message: "This breaker contains non-light items"
    help: "Remove {non_light_items} or move lights to another breaker"

  light_max_count:
    applies_to: Breaker
    description: "Light breakers can have maximum 8 lights"
    condition:
      type: has_light_items
    validation:
      type: max_count
      attribute: light_items
      max_value: 8
    severity: error
    message: "Light breaker has {actual_count} lights (maximum {max_value} allowed)"
    help: "Remove excess lights or split across multiple breakers"

  light_max_current:
    applies_to: Breaker
    description: "Light breakers must be maximum 16A"
    condition:
      type: has_light_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 16
    severity: error
    message: "Light breaker is {actual_value}A (maximum {max_value}A allowed)"
    help: "Use a lower amperage breaker or move some lights to another circuit"

  light_min_cable:
    applies_to: Breaker
    description: "Light breakers must use minimum 1.5 mm² cable"
    condition:
      type: has_light_items
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 1.5
    severity: error
    message: "Light breaker must use minimum 1.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 1.5 mm² or larger"

  socket_only:
    applies_to: Breaker
    description: "Socket breakers must contain only sockets"
    condition:
      type: has_socket_items
    validation:
      type: exclusive_type
      required_type: socket
    severity: error
    message: "This breaker contains non-socket items"
    help: "Remove {non_socket_items} or move sockets to another breaker"

  socket_16a_max_count:
    applies_to: Breaker
    description: "16A socket breakers can have maximum 8 sockets"
    condition:
      type: socket_breaker_16a
    validation:
      type: max_count
      attribute: socket_items
      max_value: 8
    severity: error
    message: "16A socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Remove excess sockets or use a 20A breaker"

  socket_16a_cable:
    applies_to: Breaker
    description: "16A socket breakers must use minimum 1.5 mm² cable"
    condition:
      type: socket_breaker_16a
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 1.5
    severity: error
    message: "16A socket breaker must use minimum 1.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 1.5 mm² or larger"

  socket_20a_max_count:
    applies_to: Breaker
    description: "20A socket breakers can have maximum 12 sockets"
    condition:
      type: socket_breaker_20a
    validation:
      type: max_count
      attribute: socket_items
      max_value: 12
    severity: error
    message: "20A socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Remove excess sockets or split across multiple breakers"

  socket_20a_cable:
    applies_to: Breaker
    description: "20A socket breakers must use minimum 2.5 mm² cable"
    condition:
      type: socket_breaker_20a
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 2.5
    severity: error
    message: "20A socket breaker must use minimum 2.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 2.5 mm² or larger"

  socket_invalid_current:
    applies_to: Breaker
    description: "Socket breakers must be either 16A or 20A"
    condition:
      type: has_socket_items
    validation:
      type: attribute_in_list
      attribute: output_max_current
      allowed_values: [16, 20]
    severity: error
    message: "Socket breaker is {actual_value}A (must be 16A or 20A)"
    help: "Change breaker amperage to either 16A or 20A"

  kitchen_socket_max_current:
    applies_to: Breaker
    description: "Kitchen socket breakers must be maximum 20A"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 20
    severity: error
    message: "Kitchen socket breaker must be maximum 20A (currently: {actual_value}A)"
    help: "Change breaker amperage to 20A or lower for kitchen sockets"

  kitchen_socket_cable:
    applies_to: Breaker
    description: "Kitchen socket breakers must use minimum 2.5 mm² cable"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 2.5
    severity: error
    message: "Kitchen socket breaker must use minimum 2.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 2.5 mm² or larger for kitchen sockets"

  kitchen_socket_max_count:
    applies_to: Breaker
    description: "Kitchen socket breakers can have maximum 6 sockets"
    condition:
      type: kitchen_socket_breaker
    validation:
      type: max_count
      attribute: socket_items
      max_value: 6
    severity: error
    message: "Kitchen socket breaker has {actual_count} sockets (maximum {max_value} allowed)"
    help: "Kitchen circuits are limited to 6 sockets maximum"

  shutter_max_current:
    applies_to: Breaker
    description: "Shutter breakers must be maximum 16A"
    condition:
      type: has_shutter_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 16
    severity: error
    message: "Shutter breaker must be maximum 16A (currently: {actual_value}A)"
    help: "Change breaker amperage to 16A or lower for shutters"

  shutter_cable:
    applies_to: Breaker
    description: "Shutter breakers must use minimum 1.5 mm² cable"
    condition:
      type: has_shutter_items
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 1.5
    severity: error
    message: "Shutter breaker must use minimum 1.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 1.5 mm² or larger for shutters"

  convector_exclusive:
    applies_to: Breaker
    description: "Convector breakers must be dedicated (convectors only)"
    condition:
      type: has_convector_items
    validation:
      type: breaker_exclusive_for_type
      item_types: ["convector"]
    severity: error
    message: "Convector breakers must only contain convectors (found: {non_allowed_items})"
    help: "Move non-convector items to another breaker"

  convector_max_power:
    applies_to: Breaker
    description: "Convector breakers can have maximum 4500W total power"
    condition:
      type: has_convector_items
    validation:
      type: max_total_power
      item_type: "convector"
      max_power: 4500
    severity: error
    message: "Convector breaker has {total_power}W (maximum {max_power}W allowed)"
    help: "Split convectors across multiple breakers or reduce total power"

  convector_max_current:
    applies_to: Breaker
    description: "Convector breakers must be maximum 20A"
    condition:
      type: has_convector_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 20
    severity: error
    message: "Convector breaker must be maximum 20A (currently: {actual_value}A)"
    help: "Change breaker amperage to 20A or lower"

  convector_min_cable:
    applies_to: Breaker
    description: "Convector breakers must use minimum 2.5 mm² cable"
    condition:
      type: has_convector_items
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 2.5
    severity: error
    message: "Convector breaker must use minimum 2.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 2.5 mm² or larger"

  appliance_exclusive:
    applies_to: Breaker
    description: "High-power appliance breakers must be dedicated (one appliance per breaker)"
    condition:
      type: has_high_power_appliance_items
    validation:
      type: breaker_exclusive_for_type
      item_types: ["dishwasher", "washing machine", "dryer", "oven"]
    severity: error
    message: "Appliance breakers must only contain one of: dishwasher, washing machine, dryer, or oven (found other items: {non_allowed_items})"
    help: "Move other items to separate breakers"

  appliance_max_current:
    applies_to: Breaker
    description: "High-power appliance breakers must be maximum 20A"
    condition:
      type: has_high_power_appliance_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 20
    severity: error
    message: "Appliance breaker must be maximum 20A (currently: {actual_value}A)"
    help: "Change breaker amperage to 20A or lower"

  appliance_min_cable:
    applies_to: Breaker
    description: "High-power appliance breakers must use minimum 2.5 mm² cable"
    condition:
      type: has_high_power_appliance_items
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 2.5
    severity: error
    message: "Appliance breaker must use minimum 2.5 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 2.5 mm² or larger"

  cooktop_exclusive:
    applies_to: Breaker
    description: "Cooktop breakers must be dedicated (cooktop only)"
    condition:
      type: has_cooktop_items
    validation:
      type: breaker_exclusive_for_type
      item_types: ["cooktop"]
    severity: error
    message: "Cooktop breakers must only contain cooktops (found: {non_allowed_items})"
    help: "Move non-cooktop items to another breaker"

  cooktop_max_current:
    applies_to: Breaker
    description: "Cooktop breakers must be maximum 32A"
    condition:
      type: has_cooktop_items
    validation:
      type: max_attribute
      attribute: output_max_current
      max_value: 32
    severity: error
    message: "Cooktop breaker must be maximum 32A (currently: {actual_value}A)"
    help: "Change breaker amperage to 32A or lower"

  cooktop_min_cable:
    applies_to: Breaker
    description: "Cooktop breakers must use minimum 6 mm² cable"
    condition:
      type: has_cooktop_items
    validation:
      type: min_cable_section
      path: breaker.output_cable.section
      min_section: 6
    severity: error
    message: "Cooktop breaker must use minimum 6 mm² cable (currently: {actual_value} mm²)"
    help: "Change the output cable to 6 mm² or larger"

# ========================================
# ITEM RULES
# ========================================
item_rules:
  cooktop_rcd_type:
    applies_to: Item
    description: "Cooktop must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: cooktop
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "Cooktop must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this cooktop to a breaker under an RCD type A"

  washing_machine_rcd_type:
    applies_to: Item
    description: "Washing machine must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: washing machine
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "Washing machine must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this washing machine to a breaker under an RCD type A"

  ev_charger_rcd_type:
    applies_to: Item
    description: "EV charger must be connected to RCD type A"
    condition:
      type: item_type_equals
      value: ev charger
    validation:
      type: association_attribute
      path: breaker.residual_current_device.residual_current_device_type.name
      must_equal: "A"
    severity: error
    message: "EV charger must be connected to RCD type A (currently: {actual_value})"
    help: "Connect this EV charger to a breaker under an RCD type A"

# ========================================
# RCD RULES
# ========================================
rcd_rules:
  max_breakers:
    applies_to: ResidualCurrentDevice
    description: "RCD can have maximum 8 breakers"
    validation:
      type: association_count
      association: breakers
      max_count: 8
    severity: error
    message: "RCD has {actual_count} breakers (maximum {max_count} allowed)"
    help: "Remove excess breakers or add another RCD"

  load_capacity:
    applies_to: ResidualCurrentDevice
    description: "RCD current capacity must handle connected load"
    validation:
      type: load_calculation
      full_load_types:
        - ev charger
        - convector
        - water heater
        - a/c
    severity: error
    message: "RCD max current ({rcd_current}A) insufficient for load ({required_current}A)"
    help: "Use a higher amperage RCD or redistribute load across multiple RCDs"

# ========================================
# SYSTEM RULES
# ========================================
system_rules:
  min_light_circuits:
    applies_to: System
    description: "Installation must have minimum 2 light breakers"
    validation:
      type: min_light_breakers
      min_value: 2
    severity: error
    message: "Installation has only {actual_count} light breaker(s) (minimum {min_value} required)"
    help: "Create at least one additional breaker with light items"

  min_shutter_circuits:
    applies_to: Dwelling
    description: "Dwelling must have at least 1 dedicated shutter breaker"
    validation:
      type: min_shutter_breakers
      min_value: 1
    severity: error
    message: "Dwelling has {actual_count} shutter breaker(s) (minimum {min_value} required)"
    help: "Create at least one breaker dedicated to roller shutters"

  min_appliance_circuits:
    applies_to: Dwelling
    description: "Dwelling must have at least 3 dedicated appliance circuits"
    validation:
      type: min_appliance_circuits
      min_value: 3
      appliance_types: ["dishwasher", "washing machine", "dryer", "oven"]
    severity: error
    message: "Dwelling has {actual_count} appliance circuit(s) (minimum {min_value} required for dishwasher, washing machine, dryer, or oven)"
    help: "Create at least 3 dedicated breakers for dishwashers, washing machines, dryers, or ovens"

  surge_protection_required:
    applies_to: Dwelling
    description: "Surge protection is required based on dwelling characteristics and location (NF C 15-100)"
    validation:
      type: surge_protection_required
    severity: error
    message: "Surge protection is required but not installed ({reason})"
    help: "Install a surge protection device (parafoudre) in the electrical panel"
