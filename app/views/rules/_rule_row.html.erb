<% editing ||= false %>
<% if editing %>
  <% form_id = dom_id(rule, :form) %>
  <% if rule.errors.any? %>
    <tr>
      <td colspan="6" style="background-color: #fee; padding: 1rem;">
        <strong><%= pluralize(rule.errors.count, "error") %> prohibited this rule from being saved:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
          <% rule.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </td>
    </tr>
  <% end %>
  <tr class="editing" id="<%= dom_id(rule) %>">
    <td><textarea name="rule[description]" form="<%= form_id %>" class="form-input" style="width: 100%; min-width: 200px; min-height: 60px;"><%= rule.description %></textarea></td>
    <td>
      <select name="rule[applies_to]" form="<%= form_id %>" class="form-input" style="width: 100%; min-width: 150px;">
        <option value="">Select resource</option>
        <% ["Item", "Breaker", "ResidualCurrentDevice", "ElectricalPanel", "Room", "Floor"].each do |resource| %>
          <option value="<%= resource %>" <%= 'selected' if rule.applies_to == resource %>><%= resource %></option>
        <% end %>
      </select>
    </td>
    <td><textarea name="rule[rule]" form="<%= form_id %>" class="form-input" style="width: 100%; min-width: 300px; min-height: 60px; font-family: monospace; font-size: 12px;"><%= rule.rule %></textarea></td>
    <td style="text-align: center;">-</td>
    <td>-</td>
    <td class="actions">
      <input type="submit" value="Save" form="<%= form_id %>" class="button-small button-primary">
      <%= link_to "Cancel", rules_path, class: "button-small button-secondary" %>
    </td>
  </tr>
<% else %>
  <tr id="<%= dom_id(rule) %>">
    <td style="max-width: 300px;"><%= rule.description %></td>
    <td><%= rule.applies_to %></td>
    <td style="max-width: 400px; overflow: auto;"><pre style="margin: 0; font-size: 12px; white-space: pre-wrap;"><%= rule.rule %></pre></td>
    <td style="text-align: center;">
      <span style="font-size: 24px; color: <%= rule.status_color %>;">●</span>
      <div style="font-size: 10px; color: #666;"><%= rule.verification_status.to_s.titleize %></div>
      <div style="font-size: 9px; color: #999; margin-top: 2px;"><%= rule.last_verification_summary %></div>
    </td>
    <td>
      <% unresolved_violations = rule.rule_violations.where(resolved: false) %>
      <% if unresolved_violations.any? %>
        <ul style="margin: 0; padding-left: 1.5rem; font-size: 12px;">
          <% unresolved_violations.limit(3).each do |violation| %>
            <li>
              <%= violation.message %> (<%= violation.context["resource_name"] %>)
              <% if violation.context["actual_count"] %>
                - <%= violation.context["actual_count"] %>/<%= violation.context["max_count"] %>
              <% elsif violation.context["total_required"] %>
                - RCD: <%= violation.context["rcd_max_current"] %>A, Required: <%= violation.context["total_required"] %>A
                (Full: <%= violation.context["full_load_sum"] %>A + Partial: <%= violation.context["partial_load_sum"] %>A×0.5)
              <% elsif violation.context["non_light_items"] %>
                - Mixed types: <%= violation.context["non_light_items"] %>
              <% elsif violation.context["item_count"] %>
                - Has <%= violation.context["item_count"] %> items (min: <%= violation.context["min_required"] %>)
              <% elsif violation.context["breaker_current"] %>
                - Breaker: <%= violation.context["breaker_current"] %>A (max: <%= violation.context["max_allowed"] %>A)
              <% elsif violation.context["light_count"] %>
                - <%= violation.context["light_count"] %>/<%= violation.context["max_lights"] %> lights
              <% end %>
            </li>
          <% end %>
          <% if unresolved_violations.count > 3 %>
            <li>... and <%= unresolved_violations.count - 3 %> more</li>
          <% end %>
        </ul>
      <% else %>
        <span style="color: #666;">No violations</span>
      <% end %>
    </td>
    <td class="actions">
      <%= button_to "Verify", verify_rule_path(rule), method: :post, class: "button-small button-primary" %>
      <%= link_to "Edit", edit_rule_path(rule), class: "button-small button-secondary" %>
      <%= button_to "Delete", rule, method: :delete, class: "button-small button-danger",
          form: { data: { turbo_confirm: "Are you sure you want to delete this rule?" } } %>
    </td>
  </tr>
<% end %>
